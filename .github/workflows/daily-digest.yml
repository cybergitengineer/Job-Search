name: Daily AI Internship Digest

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  digest:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Step 1 - Fetch jobs (writes scripts/digest.md)
        env:
          SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
          GITHUB_TOKEN: ${{ github.token }}
        run: python scripts/fetch_jobs.py

      - name: Verify digest exists
        run: |
          test -f ./scripts/digest.md || (echo "scripts/digest.md not found" && exit 1)
          echo "Digest size:" && wc -c ./scripts/digest.md

      - name: Step 2 - Create digest issue from file
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require("fs");
            const path = "./scripts/digest.md";
            const body = fs.readFileSync(path, "utf8");

            const now = new Date();
            const yyyy = now.getUTCFullYear();
            const mm = String(now.getUTCMonth() + 1).padStart(2, "0");
            const dd = String(now.getUTCDate()).padStart(2, "0");
            const hh = String(now.getUTCHours()).padStart(2, "0");
            const min = String(now.getUTCMinutes()).padStart(2, "0");

            const title = `Daily AI Internship Digest - ${yyyy}-${mm}-${dd}-${hh}-${min}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ["needs-review"]
            });
